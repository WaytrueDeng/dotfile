import{f as K,p as R,r as O,j as w,a as e,F as ae,S as ze,_ as c,b as X,R as We,C as Se,I as _,c as B,d as ne,P as Ue,M as ge,B as L,e as pe,g as Ke,h as Ye,i as Ge,k as Y,l as he,m as fe,n as S,o as ie,q as G,s as Ve,t as Qe,u as ve,v as Je,w as De,x as Xe,y as Ze,z as ye,D as et,A as tt,E as rt,G as at,L as nt,H as lt,J as ot,K as st,N as it,O as ct,Q as dt,T as ut,U as xe,V as mt}from"./vendor.be6db2e9.js";const gt=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))d(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const m of o.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&d(m)}).observe(document,{childList:!0,subtree:!0});function l(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function d(n){if(n.ep)return;n.ep=!0;const o=l(n);fetch(n.href,o)}};gt();const Z="yyyy-MM-dd",qe="yyyy-MM-dd EEE",pt="Daily Log",le=/^((?:[0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9])(-(?:[0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9])*/,Ie=[{value:"day",label:"Daily"},{value:"week",label:"Weekly"},{value:"2week",label:"2 Weeks"},{value:"month",label:"Monthly"}],ht=[{value:"light",label:"Light"},{value:"dark",label:"Dark"},{value:"auto",label:"Auto"}],oe={theme:"auto",defaultView:"month",weekStartDay:0,defaultDuration:{value:.5,unit:"h"},logKey:{id:pt,bgColor:"#047857",textColor:"#fff",borderColor:"#047857",enabled:!0},calendarList:[{id:"journal",bgColor:"#047857",textColor:"#fff",borderColor:"#047857",enabled:!0,query:[{script:`
[:find (pull ?block [*])
  :where
  [?block :block/marker ?marker]
  [(missing? $ ?block :block/deadline)]
  (not [(missing? $ ?block :block/scheduled)])
  [(contains? #{"TODO" "DOING" "NOW" "LATER" "WAITING" "DONE"} ?marker)]]
          `,scheduleStart:"scheduled",dateFormatter:"yyyyMMdd",queryType:"advanced",isMilestone:!1},{script:`
[:find (pull ?block [*])
  :where
  [?block :block/marker ?marker]
  [(missing? $ ?block :block/scheduled)]
  (not [(missing? $ ?block :block/deadline)])
  [(contains? #{"TODO" "DOING" "NOW" "LATER" "WAITING" "DONE"} ?marker)]]
          `,scheduleStart:"deadline",dateFormatter:"yyyyMMdd",queryType:"advanced",isMilestone:!1},{script:`
[:find (pull
  ?block
  [:block/uuid
    :db/id
    :block/parent
    :block/left
    :block/collapsed?
    :block/format
    :block/_refs
    :block/path-refs
    :block/tags
    :block/content
    :block/marker
    :block/priority
    :block/properties
    :block/pre-block?
    :block/scheduled
    :block/deadline
    :block/repeated?
    :block/created-at
    :block/updated-at
    :block/file
    :block/heading-level
    {:block/page
    [:db/id :block/name :block/original-name :block/journal-day :block/journal?]}])
  :where
  [?block :block/page ?page]
  [?page :block/journal? true]
  [?block :block/marker ?marker]
  [(contains? #{"TODO" "DOING" "NOW" "LATER" "WAITING" "DONE"} ?marker)]
  [(missing? $ ?block :block/scheduled)]
  [(missing? $ ?block :block/deadline)]]
          `,scheduleStart:"page.journal-day",dateFormatter:"yyyyMMdd",isMilestone:!1,queryType:"advanced"},{script:`
[:find (pull ?block [*])
  :where
  [?rp :block/name "milestone"]
  [?block :block/refs ?rp]]
          `,scheduleStart:"scheduled",dateFormatter:"yyyyMMdd",isMilestone:!0,queryType:"advanced"}]}],subscriptionList:[]},ft={"month.holidayExceptThisMonth.color":"#f3acac","month.dayExceptThisMonth.color":"#bbb","month.weekend.backgroundColor":"#fafafa","month.day.fontSize":"16px","week.daygrid.borderRight":"1px solid #ddd","week.daygrid.backgroundColor":"inherit","week.daygridLeft.width":"77px","week.daygridLeft.backgroundColor":"#a8def74d","week.daygridLeft.paddingRight":"5px","week.daygridLeft.borderRight":"1px solid #ddd","week.today.backgroundColor":"#b857d81f","week.weekend.backgroundColor":"#fafafa","week.timegridLeft.width":"77px","week.timegridLeft.backgroundColor":"#03a9f44d","week.timegridLeft.borderRight":"1px solid #ddd","week.timegridLeft.fontSize":"12px","week.timegridLeftTimezoneLabel.height":"51px","week.timegridLeftAdditionalTimezone.backgroundColor":"#fdfdfd","week.timegridOneHour.height":"48px","week.timegridHalfHour.height":"24px","week.timegridHalfHour.borderBottom":"1px dotted #f9f9f9","week.timegridHorizontalLine.borderBottom":"1px solid #eee","week.timegrid.paddingRight":"10px","week.timegrid.borderRight":"1px solid #ddd","week.timegridSchedule.borderRadius":"0","week.timegridSchedule.paddingLeft":"0","week.currentTime.color":"#135de6","week.currentTime.fontSize":"12px","week.currentTime.fontWeight":"bold","week.pastTime.color":"#808080","week.pastTime.fontWeight":"normal","week.futureTime.color":"#333","week.futureTime.fontWeight":"normal","week.currentTimeLinePast.border":"1px solid rgba(19, 93, 230, 0.3)","week.currentTimeLineBullet.backgroundColor":"#135de6","week.currentTimeLineToday.border":"1px solid #135de6","week.currentTimeLineFuture.border":"1px solid #135de6"},Ee="yyyyMMdd",yt=[{value:"m",label:"minute"},{value:"h",label:"hour"}],kt=async(r,t)=>{const l=logseq.settings?.logKey?.id||oe.logKey?.id,{preferredDateFormat:d}=await logseq.App.getUserConfigs(),n=d||qe,o=K(R(r,Z,new Date),n),m=K(R(t,Z,new Date),n);return(await logseq.DB.q(`(and [[${l}]] (between [[${o}]] [[${m}]]))`))?.filter(s=>s.content?.trim()===`[[${l}]]`)?.map(s=>Array.isArray(s.parent)?s.parent:[])?.flat()?.filter(s=>(s.content?.trim()).length>0)},ke=(r,t="blue")=>console.log(`%c${r}`,`color:${t}`),be=r=>{const t=document.querySelector("html");r==="dark"?t?.classList.add("dark"):t?.classList.remove("dark")},Oe=async()=>{const{theme:r}=logseq.settings;if(r==="dark")return be("dark");if(r==="light")return be("light");const t=await logseq.App.getStateFromStore("ui/theme");be(t)},bt=r=>{const t=document.createElement("textarea");t.value=r,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)},wt=r=>{document.addEventListener("keyup",t=>{t.key==="Escape"&&r()})},Ct=()=>{const r=navigator.userAgent,t=r.indexOf("Windows")>-1,l=r.indexOf("Macintosh")>-1,d=r.indexOf("Linux")>-1;return t?"windows":l?"mac":d?"linux":"unknown"},V=({value:r,onChange:t,text:l})=>{const[d,n]=O.exports.useState(!1);return w("div",{children:[e("span",{style:{backgroundColor:r},className:"px-2 py-1 rounded cursor-pointer shadow-md",onClick:()=>n(!0),children:l}),d&&w(ae,{children:[e("div",{className:"bg-transparent fixed top-0 left-0 w-screen h-screen",onClick:()=>n(!1)}),e(ze,{color:r,onChange:m=>{t?.(m.hex)},className:"absolute bottom-10 z-10"})]})]})},St=({visible:r,calendarId:t,initialValues:l,onCancel:d,onOk:n,...o})=>{const[m]=c.useForm(),p=()=>{const s=m.getFieldsValue(!0);n?.(s?.query)},k=async s=>{const i=m.getFieldsValue(!0)?.query[s];if(i){console.log(""),ke(`[faiz:] === start exec your query:
`,"blue"),console.log(i?.script);try{let y;i?.queryType==="simple"?y=await logseq.DB.q(i?.script):y=await logseq.DB.datascriptQuery(i.script),ke(`[faiz:] === exec your query success:
`,"green"),console.log(y)}catch(y){ke(`[faiz:] === exec your query failed:
`,"red"),console.error(y)}console.log("")}};return e(X,{...o,width:980,title:"Calendar Queries (saved searches)",visible:r,onCancel:d,onOk:p,children:e("div",{className:"overflow-y-auto overflow-x-hidden",style:{maxHeight:"500px"},children:e(c,{initialValues:{query:l},form:m,size:"small",children:e(c.List,{name:"query",children:(s,{add:i,remove:y})=>w(ae,{children:[s.map((C,h)=>w("div",{className:"rounded border-dashed border-gray-200 px-4 pt-4 mb-3 relative",children:[e(c.Item,{label:`Query ${h+1}`,children:w(We,{gutter:16,children:[e(Se,{span:12,children:e(c.Item,{label:"script",name:[C.name,"script"],labelCol:{span:4},children:e(_.TextArea,{rows:10})})}),w(Se,{span:12,children:[e(c.Item,{label:"Query Type",name:[C.name,"queryType"],labelCol:{span:7},children:w(B.Group,{children:[e(B,{value:"simple",children:"Simple Query"}),e(B,{value:"advanced",children:"Advanced Query"})]})}),e(c.Item,{label:"Schedule Start",name:[C.name,"scheduleStart"],labelCol:{span:7},children:e(_,{})}),e(c.Item,{label:"Schedule End",name:[C.name,"scheduleEnd"],labelCol:{span:7},children:e(_,{})}),e(c.Item,{label:"Date Formatter",name:[C.name,"dateFormatter"],labelCol:{span:7},children:e(_,{})}),e(c.Item,{label:"Is Milestone",name:[C.name,"isMilestone"],labelCol:{span:7},children:w(B.Group,{children:[e(B,{value:!0,children:"Yes"}),e(B,{value:!1,children:"No"})]})})]})]})}),w("div",{className:"absolute bottom-4 right-4",children:[e(ne,{title:"Execute this query in DevTools",children:e(Ue,{onClick:()=>k(h)})}),h!==0&&e(ge,{className:"ml-2",onClick:()=>y(C.name)})]})]},h)),e(c.Item,{children:e(L,{type:"dashed",size:"small",onClick:()=>i(),block:!0,icon:e(pe,{}),children:"Add Schedule Query"})})]})})})})})},vt=({value:r,onChange:t,calendarId:l})=>{const[d,n]=O.exports.useState(!1);return w("div",{children:[e(ne,{title:"Edit Calendar Queries",children:e(L,{type:"link",icon:e(Ke,{}),onClick:()=>n(!0)})}),e(St,{visible:d,calendarId:l,initialValues:r,onCancel:()=>n(!1),onOk:o=>{t?.(o),n(!1)}})]})},Dt=({visible:r,onCancel:t,onSave:l})=>{const[d]=c.useForm(),n=async o=>{const m=await logseq.Editor.getPage(o);if(console.log("[faiz:] === createAgendaPage getPage",m),m)return logseq.App.showMsg(`The page with the same name already exists
Please add properties to the page manually
agenda:: true`,"error"),{success:!0};const p=await logseq.Editor.createPage(o,{agenda:!0});return console.log("[faiz:] === createAgendaPage createPage",p),{success:!0}};return e(X,{title:"Create Calendar",visible:r,onOk:()=>{d.validateFields().then(async o=>{const m=o.calendarId.trim();if(o.agenda){const{success:p}=await n(m);if(!p)return}l({name:m,agenda:Boolean(o.agenda)})})},onCancel:t,children:w(c,{form:d,children:[e(c.Item,{name:"calendarId",label:"Calendar ID",rules:[{required:!0}],children:e(_,{})}),e(c.Item,{name:"agenda",label:"Control By Agenda",tooltip:"Checking means that the plugin may modify this document",children:w(B.Group,{children:[e(B,{value:!0,children:"Yes"}),e(B,{value:!1,children:"No"})]})})]})})},se=()=>{let r=logseq.settings?.logKey;return typeof r=="string"&&(r={...oe.logKey,id:r}),{...oe,...logseq.settings,logKey:r}},xt=()=>{if(!logseq.settings?.initialized){const t=se();logseq.updateSettings({...t,initialized:!0}),console.log("[faiz:] === initialize settings success",logseq.settings)}},qt=()=>{let r=logseq.settings?.defaultView||"month";return logseq.settings?.defaultView==="2week"&&(r="month"),{defaultView:r,taskView:!0,scheduleView:!0,useDetailPopup:!0,isReadOnly:!1,disableClick:!0,theme:ft,usageStatistics:!1,week:{startDayOfWeek:logseq.settings?.weekStartDay||0,hourStart:logseq.settings?.weekHourStart||0,hourEnd:logseq.settings?.weekHourEnd||24},month:{startDayOfWeek:logseq.settings?.weekStartDay||0,scheduleFilter:t=>Boolean(t.isVisible),visibleWeeksCount:logseq.settings?.defaultView==="2week"?2:void 0},template:{taskTitle:()=>'<span class="tui-full-calendar-left-content">Overdue</span>',task:t=>"\u{1F525}"+t.title,timegridDisplayPrimayTime:function(t){return t.hour<10?"0"+t.hour+":00":t.hour+":00"},popupDetailBody:t=>{const l=`<br/><b>Calendar: ${t.calendarId}</b>`,d=t.raw?.subscription?"":'<br/><a id="faiz-nav-detail" href="javascript:void(0);">Navigate To Block</a>';return`
          <div class="calendar-popup-detail-content">
            ${t.body?.split(`
`).join("<br/>")}
          </div>
          ${l}
          ${d}
        `}}}},It=r=>({id:r,bgColor:"#b8e986",textColor:"#4a4a4a",borderColor:"#047857",enabled:!0,query:[{script:`
[:find (pull ?block [*])
:where
[?block :block/marker ?marker]
[(missing? $ ?block :block/deadline)]
(not [(missing? $ ?block :block/scheduled)])
[?page :block/name ?pname]
[?block :block/page ?page]
[(contains? #{"${r}"} ?pname)]
[(contains? #{"TODO" "DOING" "NOW" "LATER" "WAITING" "DONE"} ?marker)]]
        `,scheduleStart:"scheduled",dateFormatter:"yyyyMMdd"},{script:`
[:find (pull ?block [*])
:where
[?block :block/marker ?marker]
[(missing? $ ?block :block/scheduled)]
[(get-else $ ?block :block/deadline "nil") ?d]
[(not= ?d "nil")]
[?page :block/name ?pname]
[?block :block/page ?page]
[(contains? #{"${r}"} ?pname)]
[(contains? #{"TODO" "DOING" "NOW" "LATER" "WAITING" "DONE"} ?marker)]]
        `,scheduleStart:"deadline",dateFormatter:"yyyyMMdd"},{script:`
[:find (pull ?block [*])
:where
[?page :block/name ?pname]
[?block :block/page ?page]
[(contains? #{"${r}"} ?pname)]
[?rp :block/name "milestone"]
[?block :block/refs ?rp]]
        `,scheduleStart:"scheduled",dateFormatter:"yyyyMMdd",isMilestone:!0}]}),Et=r=>({id:r,bgColor:"#b8e986",textColor:"#4a4a4a",borderColor:"#047857",enabled:!0,query:[{script:`(and (page "${r}") (property end) (property start))`,scheduleStart:"properties.start",scheduleEnd:"properties.end",dateFormatter:"yyyy-MM-dd",queryType:"simple"},{script:`(and (page "${r}") (property end) (property start))`,scheduleStart:"properties.start",scheduleEnd:"properties.end",dateFormatter:"yyyy-MM-dd HH:mm",queryType:"simple"}]}),Ot=({visible:r,onCancel:t,onOk:l,...d})=>{const[n]=Ye.useForm(),[o,m]=O.exports.useState(!1),p=se(),k=()=>{n.validateFields().then(i=>{l(i)})},s=({name:i,agenda:y=!1})=>{n.setFieldsValue({calendarList:[...n.getFieldValue("calendarList"),y?Et(i):It(i)]}),m(!1)};return e(ae,{children:w(X,{...d,width:700,destroyOnClose:!0,title:"Calendar Settings",visible:r,onCancel:t,footer:w("div",{className:"flex justify-between",onClick:i=>i?.stopPropagation?.(),children:[e(Ge,{title:w("span",{children:["Are you sure you want to restore default settings?",e("br",{}),"This is an irreversible operation."]}),onConfirm:()=>{n.setFieldsValue(oe),k()},children:e(L,{type:"link",children:"Restore Defaults"})}),w("div",{children:[e(L,{onClick:t,children:"Cancel"}),e(L,{type:"primary",onClick:k,children:"Save"})]})]}),children:[w(c,{initialValues:p,labelCol:{span:7},preserve:!0,form:n,children:[e(c.Item,{label:"Theme",name:"theme",children:e(Y,{options:ht})}),e(c.Item,{label:"Default View",name:"defaultView",rules:[{required:!0}],children:e(Y,{options:Ie})}),e(c.Item,{label:"Week Start Day",name:"weekStartDay",rules:[{required:!0}],children:w(Y,{children:[e(Y.Option,{value:0,children:"Sunday"}),e(Y.Option,{value:1,children:"Monday"})]})}),e(c.Item,{label:"Time Grid",children:w("div",{className:"flex items-center",children:[e(c.Item,{noStyle:!0,name:"weekHourStart",children:e(he,{min:0,max:24})}),e("span",{className:"px-2",children:"-"}),e(c.Item,{noStyle:!0,name:"weekHourEnd",children:e(he,{min:0,max:24})})]})}),e(c.Item,{label:"Default Duration",name:["defaultDuration","value"],children:e(he,{addonAfter:e(c.Item,{name:["defaultDuration","unit"],noStyle:!0,children:e(Y,{style:{width:80},options:yt})})})}),e(c.Item,{label:"Log Key",required:!0,children:w("div",{className:"flex items-center justify-between",children:[e(c.Item,{noStyle:!0,name:["logKey","id"],rules:[{required:!0}],children:e(_,{style:{width:"110px"}})}),e(c.Item,{name:["logKey","bgColor"],noStyle:!0,rules:[{required:!0}],children:e(V,{text:"background"})}),e(c.Item,{name:["logKey","textColor"],noStyle:!0,rules:[{required:!0}],children:e(V,{text:"text"})}),e(c.Item,{name:["logKey","borderColor"],noStyle:!0,rules:[{required:!0}],children:e(V,{text:"border"})}),e(c.Item,{name:["logKey","enabled"],noStyle:!0,valuePropName:"checked",children:e(fe,{size:"small"})}),e("div",{style:{width:"60px"}})]})}),e(c.List,{name:"calendarList",children:(i,{add:y,remove:C})=>w(ae,{children:[i.map((h,a)=>e(c.Item,{required:!0,label:a===0?"Calendar":"",...a===0?{}:{wrapperCol:{offset:7}},children:w("div",{className:"flex items-center justify-between",children:[e(c.Item,{name:[h.name,"id"],noStyle:!0,rules:[{required:!0}],children:e(_,{placeholder:"Calendar ID",disabled:a===0,style:{width:"110px"}})}),e(c.Item,{name:[h.name,"bgColor"],noStyle:!0,rules:[{required:!0}],children:e(V,{text:"background"})}),e(c.Item,{name:[h.name,"textColor"],noStyle:!0,rules:[{required:!0}],children:e(V,{text:"text"})}),e(c.Item,{name:[h.name,"borderColor"],noStyle:!0,rules:[{required:!0}],children:e(V,{text:"border"})}),e(c.Item,{name:[h.name,"query"],noStyle:!0,rules:[{required:!0}],children:e(vt,{calendarId:"query"})}),e(c.Item,{name:[h.name,"enabled"],noStyle:!0,valuePropName:"checked",children:e(fe,{size:"small"})}),a!==0?e(ge,{onClick:()=>C(h.name)}):e("div",{style:{width:"14px"}})]})})),e(c.Item,{wrapperCol:{offset:7},children:e(L,{type:"dashed",size:"small",onClick:()=>m(!0),block:!0,icon:e(pe,{}),children:"Add Calendar"})})]})}),e(c.List,{name:"subscriptionList",children:(i,{add:y,remove:C})=>w(ae,{children:[i.map((h,a)=>e(c.Item,{label:a===0?"Subscription":"",...a===0?{}:{wrapperCol:{offset:7}},children:w("div",{className:"flex items-center justify-between",children:[e(c.Item,{name:[h.name,"id"],noStyle:!0,rules:[{required:!0}],children:e(_,{placeholder:"Calendar ID",style:{width:"100px"}})}),e(c.Item,{name:[h.name,"url"],noStyle:!0,rules:[{required:!0,type:"url"}],children:e(_,{placeholder:"Url",style:{width:"100px"}})}),e(c.Item,{name:[h.name,"bgColor"],noStyle:!0,rules:[{required:!0}],children:e(V,{text:"background"})}),e(c.Item,{name:[h.name,"textColor"],noStyle:!0,rules:[{required:!0}],children:e(V,{text:"text"})}),e(c.Item,{name:[h.name,"borderColor"],noStyle:!0,rules:[{required:!0}],children:e(V,{text:"border"})}),e(c.Item,{name:[h.name,"enabled"],noStyle:!0,valuePropName:"checked",children:e(fe,{size:"small"})}),e(ge,{onClick:()=>C(h.name)})]})})),e(c.Item,{wrapperCol:{offset:7},children:e(L,{type:"dashed",size:"small",onClick:()=>y(),block:!0,icon:e(pe,{}),children:"Add Subscription"})})]})})]}),e(Dt,{visible:o,onSave:s,onCancel:()=>m(!1)})]})})},Tt=({visible:r,onCancel:t,start:l,end:d,...n})=>{const[o,m]=O.exports.useState();return O.exports.useEffect(()=>{l&&d&&kt(l,d).then(p=>{m(p?.map(k=>k.content)?.join(`

`))})},[l,d]),e(X,{...n,destroyOnClose:!0,title:"Weekly Logs",okText:"Copy And Close",visible:r,onCancel:t,onOk:()=>{bt(o||""),t()},children:e(_.TextArea,{value:o,onChange:p=>m(p.target.value),rows:10})})},Mt=async()=>{let r=[];const{calendarList:t=[],logKey:l,defaultDuration:d,subscriptionList:n}=se(),o=t.filter(i=>i.enabled);let m=[];m=o.map(i=>i?.query?.filter(y=>y?.script?.length)?.map(y=>({calendarConfig:i,query:y}))).filter(Boolean).flat();const p=m.map(async i=>{const{calendarConfig:y,query:C}=i,{script:h="",scheduleStart:a="",scheduleEnd:D="",dateFormatter:x,isMilestone:v,queryType:I}=C;let T=[];I==="simple"?T=await logseq.DB.q(h)||[]:T=await logseq.DB.datascriptQuery(h),console.log("[faiz:] === search blocks by query: ",h,T);const J=ie.exports.flattenDeep(T).map(async M=>{const $=["scheduled","deadline"].includes(a||D)?Ee:x||qe,P=ie.exports.get(M,a,void 0),f=ie.exports.get(M,D,void 0);let A=/[Hhm]+/.test($||""),N,F;try{N=P&&ce(P,$),F=f&&(A?ce(f,$):G(Ve(R(f,$,new Date))))}catch(b){return console.warn("[faiz:] === parse calendar date error: ",b,M,C),[]}if(M?.page?.["journal-day"]){const{start:b,end:E}=Te(M?.content.replace(new RegExp(`^${M.marker} `),""));if(b||E){const W=M?.page?.["journal-day"];N=b?G(R(W+" "+b,"yyyyMMdd HH:mm",new Date)):ce(W),F=E?G(R(W+" "+E,"yyyyMMdd HH:mm",new Date)):void 0,A=!0}}if(P&&["scheduled","deadline"].includes(a)){const b=M.content?.split(`
`)?.find(W=>W.startsWith(`${a.toUpperCase()}:`))?.trim(),E=/ (\d{2}:\d{2})[ >]/.exec(b)?.[1]||"";E&&(N=G(R(`${P} ${E}`,"yyyyMMdd HH:mm",new Date)),A=!0)}if(f&&["scheduled","deadline"].includes(D)){const b=M.content?.split(`
`)?.find(W=>W.startsWith(`${D.toUpperCase()}:`))?.trim();(/ (\d{2}:\d{2})[ >]/.exec(b)?.[1]||"")&&(F=G(R(F,"yyyyMMdd HH:mm",new Date)),A=!0)}let j=A?"time":"allday";v&&(j="milestone");const H=At(M,F||N);!v&&H&&(j="task");const z=await Q({blockData:M,category:j,start:N,end:F,calendarConfig:y,defaultDuration:d,isAllDay:!v&&!A&&!H});return H?[z,await Q({blockData:M,category:j,calendarConfig:y,defaultDuration:d,isAllDay:!v&&!A&&!H})]:z});return Promise.all(J)}),k=await Promise.allSettled(p),s=[];if(k.forEach((i,y)=>{if(i.status==="fulfilled")s.push(i.value);else{console.error("[faiz:] === scheduleRes error: ",m[y],i);const{calendarConfig:C,query:h}=m[y],a=`Query Exec Error:
calendar: ${C.id}
query: ${h.script}
message: ${i.reason.message}`;logseq.App.showMsg(a,"error")}}),r=ie.exports.flattenDeep(r.concat(s)),l?.enabled){const C=((await logseq.DB.q(`[[${l.id}]]`))?.filter(a=>(a.headingLevel&&a.format==="markdown"&&(a.content=a.content.replace(new RegExp(`^#{${a.headingLevel}} `),"")),a.content?.trim()===`[[${l.id}]]`))?.map(a=>Array.isArray(a.parent)?a.parent:[])?.flat()?.filter(a=>(a.content?.trim()).length>0&&a?.page?.journalDay&&!a.marker&&!a.scheduled&&!a.deadline)||[])?.map(async a=>{const D=a?.page?.journalDay,{start:x,end:v}=Te(a?.content.replace(new RegExp(`^${a.marker} `),"")),I=x||v;return await Q({blockData:a,category:I?"time":"allday",start:x?G(R(D+" "+x,"yyyyMMdd HH:mm",new Date)):ce(D),end:v?G(R(D+" "+v,"yyyyMMdd HH:mm",new Date)):void 0,calendarConfig:l,defaultDuration:d,isAllDay:!I,isReadOnly:!0})}),h=await Promise.all(C);r=r.concat(h)}return r},At=(r,t)=>r.marker&&r.marker!=="DONE"?Qe(Je(new Date),ve(t)):!1,Te=r=>{const t=r.match(le);return t?{start:t[1],end:t[2]?.slice(1)}:{start:void 0,end:void 0}},Me=(r,t,l)=>{const d=`${t}${l?"-"+l:""}`;return r.match(le)?r.replace(le,d):d+" "+r},Ae=r=>r.replace(le,""),Ne=async r=>{const t=/\(\([0-9a-z\-]{30,}\)\)/;if(t.test(r)){const l=t.exec(r)?.[0]?.replace("((","")?.replace("))","");if(l){const d=await logseq.Editor.getBlock(l);return r.replace(t,d?.content||"")}}return r};async function Q(r){const{blockData:t,category:l="time",start:d,end:n,calendarConfig:o,isAllDay:m,defaultDuration:p,isReadOnly:k}=r;if(!t?.id){const x=await logseq.Editor.getBlock(t.uuid?.$uuid$);x&&(t.id=x.id)}const s=await logseq.Editor.getPage(t?.page?.id);t.page=s;let i=t.content.split(`
`)[0]?.replace(new RegExp(`^${t.marker} `),"")?.replace(le,"")?.trim?.();i=await Ne(i),i=i?.split(`
`)[0];const y=t.marker==="DONE";function C(){return!!(t.page?.properties?.agenda===!0||t?.page?.journalDay&&!t?.scheduled&&!t?.deadline)}const h=k===void 0?C():!k,{defaultDuration:a}=oe;let D=n;if(l==="time"&&!n&&d&&p){const x=p.value||a.value,v=p.unit||a.unit;D=S(d).add(x,v).toISOString()}return{id:String(t.id),calendarId:o.id,title:y?`\u2705${i}`:i,body:await Ne(t.content),category:l,dueDateClass:"",start:d,end:D,raw:t,color:o?.textColor,bgColor:o?.bgColor,borderColor:o?.borderColor,isAllDay:m,customStyle:y?"opacity: 0.6;":"",isReadOnly:!h}}const ce=(r,t=Ee)=>G(R(""+r,t,new Date)),de=async(r,t,l)=>{const d=await logseq.Editor.getBlock(r);if(!d)return logseq.App.showMsg("Block not found","error"),Promise.reject(new Error("Block not found"));t&&await logseq.Editor.updateBlock(d.uuid,t);const n=Object.keys(l||{}).map(o=>logseq.Editor.upsertBlockProperty(d.uuid,o,l?.[o]));return Promise.allSettled(n)},Le=async(r,t,l,d)=>{const n=await logseq.Editor.getBlock(r);if(!n)return logseq.App.showMsg("moveBlockToNewPage: Block not found","error");if(!await logseq.Editor.createPage(t))return logseq.App.showMsg("Create page failed","error");await logseq.Editor.removeBlock(n.uuid);const m=await logseq.Editor.insertBlock(t,l||n?.content,{isPageBlock:!0,sibling:!0,properties:d||n?.properties});return m?await logseq.Editor.getBlock(m.uuid):logseq.App.showMsg("Failed to move block to new page")},Nt=({visible:r,initialValues:t,onCancel:l,onSave:d,type:n="create",calendar:o})=>{const[m,p]=O.exports.useState([]),[k,s]=O.exports.useState(!t?.isAllDay),[i]=c.useForm(),y=(a,D)=>{if(a.isAllDay!==void 0&&s(!a.isAllDay),a.start!==void 0&&i.setFieldsValue({end:a.start.add(1,"hour")}),a.calendarId?.value==="journal"){const x=D.start,v=D.end;x.isSame(v,"day")||i.setFieldsValue({end:x.add(1,"hour")})}},C=()=>{i.validateFields().then(async a=>{const{calendarId:D,title:x,start:v,end:I,isAllDay:T}=a,J=S(v).format("YYYY-MM-DD"),M=S(I).format("YYYY-MM-DD"),$=S(v).format("HH:mm"),P=S(I).format("HH:mm"),f=m.find(b=>b.id===D?.value);console.log("[faiz:] === onClickSave",a);const A=D?.value==="journal";if(S(v).isAfter(S(I)))return logseq.App.showMsg("Start time cannot be later than end time","error");if(A&&!S(v).isSame(S(I),"day"))return logseq.App.showMsg("Journal schedule cannot span multiple days","error");let N=`TODO ${x}`;if(A&&(n==="create"&&(N=T?`TODO ${x}`:`TODO ${$}-${P} ${x}`),n==="update")){const b=t?.raw?.marker,E=x.replace(new RegExp(`^${b} `),"");N=T?`${b} `+Ae(E):`${b} `+Me(E,$,P)}if(!A&&n==="update"){const b=t?.raw?.marker,E=x.replace(new RegExp(`^${b} `),"");N=`${b} `+Ae(E)}const F=A?{}:{start:T?J:`${J} ${$}`,end:T?M:`${M} ${P}`},{preferredDateFormat:j}=await logseq.App.getUserConfigs();let H=t?.calendarId;if(t?.calendarId==="journal"){const b=t?.start;b&&(H=K(b?.valueOf(),j))}let z=D?.value;if(D?.value==="journal"){console.log("[faiz:] === values",a);const b=K(v.valueOf(),j),E=await logseq.Editor.createPage(b,{},{journal:!0});E&&(z=E.originalName),console.log("[faiz:] === journalName",b,E)}if(n==="create"){const b=await logseq.Editor.insertBlock(z,N,{isPageBlock:!0,sibling:!0,properties:F});if(!b)return logseq.App.showMsg("Create block failed","error");const E=await logseq.Editor.getBlock(b.uuid);o?.createSchedules([await Q({blockData:E,category:T?"allday":"time",start:S(v).format(),end:S(I).format(),calendarConfig:f,isAllDay:T,isReadOnly:!1})])}else if(z!==H&&t?.id){const b=await Le(Number(t.id),z,N,F);if(!b||!t.calendarId)return;const E=await logseq.Editor.getBlock(b.uuid);o?.deleteSchedule(String(t.id),t.calendarId),o?.createSchedules([await Q({blockData:E,category:T?"allday":"time",start:S(v).format(),end:S(I).format(),calendarConfig:f,isAllDay:T,isReadOnly:!1})])}else if(t?.id){D.value==="journal"?await de(Number(t.id),N):await de(Number(t.id),x,F);const b=await logseq.Editor.getBlock(Number(t.id));console.log("[faiz:] === blockAfterUpdated",b),o?.updateSchedule(t.id,D?.value,await Q({blockData:b,category:T?"allday":"time",start:S(v).format(),end:S(I).format(),calendarConfig:f,isAllDay:T,isReadOnly:!1}))}d?.()})},h=()=>{l?.()};return O.exports.useEffect(()=>{const{calendarList:a}=logseq.settings,D=a.map(x=>logseq.Editor.getPage(x.id));Promise.all(D).then(x=>{const v=x.map((I,T)=>I&&(I?.properties?.agenda!==!0?null:a[T])).filter(function(I){return Boolean(I)});p([a[0]].concat(v))})},[]),e(X,{title:"Modify Schedule",visible:r,onOk:C,onCancel:h,children:w(c,{form:i,onValuesChange:y,initialValues:{...t,calendarId:t?.calendarId?{value:t?.calendarId}:void 0},children:[e(c.Item,{name:"calendarId",label:"Calendar",rules:[{required:!0}],children:e(Y,{labelInValue:!0,children:m.map(a=>w(Y.Option,{value:a.id,children:[e("span",{style:{width:"12px",height:"12px",display:"inline-block",backgroundColor:a.bgColor,verticalAlign:"middle",marginRight:"5px",borderRadius:"4px"}}),a.id]},a.id))})}),e(c.Item,{name:"title",label:"Schedule Title",rules:[{required:!0}],children:e(_,{})}),e(c.Item,{name:"start",label:"Start",rules:[{required:!0}],children:e(De,{showTime:k?{format:"HH:mm"}:!1})}),e(c.Item,{name:"end",label:"End",rules:[{required:!0}],children:e(De,{showTime:k?{format:"HH:mm"}:!1})}),e(c.Item,{name:"isAllDay",label:"All Day",rules:[{required:!0}],children:w(B.Group,{children:[e(B,{value:!0,children:"Yes"}),e(B,{value:!1,children:"No"})]})})]})})};const Lt=async(r,t)=>{if(!Array.isArray(r))return[];const l=r?.filter(p=>p.enabled);if(!l?.length)return[];const n=(await Promise.allSettled(l.map(p=>Xe(p.url)))).map(async(p,k)=>{if(p.status==="rejected")return logseq.App.showMsg(`Get Calendar ${l[k].id} data error
${p.reason}`,"error"),[];try{const s=Ze.parse(p.value.data),{events:i}=$t(s),y=i.map(async C=>{const{dtstart:h,dtend:a,summary:D,description:x}=C,v=h.type==="date-time";return await Q({blockData:{id:new Date().valueOf(),content:`${D?.value||"no summary"}
${x?.value||""}`,subscription:!0},category:v?"time":"allday",start:h.value,end:a?v?a?.value:G(ve(a?.value)):void 0,calendarConfig:l[k],defaultDuration:t,isAllDay:!v})});return Promise.all(y)}catch(s){return logseq.App.showMsg(`Parse Calendar ${l[k].id} data error
${s}`,"error"),console.log("[faiz:] === Parse Calendar error",s),[]}});return(await Promise.allSettled(n)).filter(p=>p?.status==="fulfilled").map(p=>p?.value)?.flat()},$t=r=>{function t(m){return m.reduce((p,k)=>({...p,[k[0]]:{type:k[2],value:k[3]}}),{})}const[l,d,n]=r,o=n.filter(m=>m[0]==="vevent").map(m=>{const[p,k]=m;return t(k)});return{type:l,info:t(d),events:o}},$e=({checked:r,color:t,onChange:l,children:d,...n})=>w("div",{onClick:()=>l?.(!r),...n,children:[e("span",{className:`check-box mr-2 ${r?"checked":""}`,style:{backgroundColor:t}}),d]}),Pt=({onShowCalendarChange:r,calendarList:t=[],subscriptionList:l=[]})=>{const[d,n]=O.exports.useState(["calendar","subscription"]),[o,m]=O.exports.useState(t.map(s=>s.id)?.concat(l?.map(s=>s.id))),p=(s,i)=>{let y=o.filter(C=>C!==s);i&&(y=o.concat(s)),m(y),r?.(y)},k=s=>e("span",{className:"text-gray-400 text-xs",children:s});return e("div",{className:"sidebar pt-2",children:w(ye,{ghost:!0,expandIconPosition:"right",activeKey:d,expandIcon:({isActive:s})=>e("span",{className:"opacity-50",children:e(et,{rotate:s?0:-90})}),onChange:s=>n(typeof s=="string"?[s]:s),children:[e(ye.Panel,{header:k("Calendar"),children:t.map(s=>e($e,{className:"mb-1 cursor-pointer flex items-center",color:s.bgColor,checked:o?.includes(s.id),onChange:i=>p(s.id,i),children:e(ne,{title:s.id,placement:"right",children:e("span",{className:"singlge-line-ellipsis flex-1",children:s.id})})},s.id))},"calendar"),l?.length>0&&e(ye.Panel,{header:k("Subscription"),className:"mt-3",children:l.map(s=>e($e,{className:"mb-1 cursor-pointer flex items-center",color:s.bgColor,checked:o?.includes(s.id),onChange:i=>p(s.id,i),children:e(ne,{title:s.id,placement:"right",children:e("span",{className:"singlge-line-ellipsis flex-1",children:s.id})})},s.id))},"subscription")]})})},Ft=({env:r})=>{const t=qt(),{calendarList:l,subscriptionList:d,logKey:n}=se(),o=(n?.enabled?[n]:[]).concat(l?.filter(u=>u.enabled)),m=d?d?.filter(u=>u.enabled):[],p=Ct()==="mac",[k,s]=O.exports.useState(!1),[i,y]=O.exports.useState(!0),[C,h]=O.exports.useState(logseq.settings?.defaultView||"month"),[a,D]=O.exports.useState(),[x,v]=O.exports.useState(Boolean(logseq.settings?.logKey?.enabled)&&logseq.settings?.defaultView==="week"),[I,T]=O.exports.useState({visible:!1}),[J,M]=O.exports.useState(!1),[$,P]=O.exports.useState({visible:!1,type:"create"}),f=O.exports.useRef(),A=()=>{if(f.current){const u=f.current.getDateRangeStart().getTime(),g=f.current.getDateRangeEnd().getTime();ct(u,g)?D(K(u,Z)):D(K(u,Z)+" ~ "+K(g,Z))}},N=()=>y(u=>!u),F=async()=>{const u=f.current;if(u){u.clear();const g=await Mt();u.createSchedules(g);const{subscriptionList:q}=await se(),ee=await Lt(q);u.createSchedules(ee)}},j=async()=>{const[u,g]=a?.split(" ~ ")||[];T({visible:!0,start:u,end:g})},H=u=>{h(u),u==="2week"?(f.current?.changeView("month"),f.current?.setOptions({month:{visibleWeeksCount:2}})):u==="month"?(f.current?.changeView("month"),f.current?.setOptions({month:{visibleWeeksCount:void 0}})):f.current?.changeView(u),A(),v(logseq.settings?.logKey?.enabled&&u==="week")},z=()=>{f.current?.today(),A()},b=()=>{f.current?.prev(),A()},E=()=>{f.current?.next(),A()},W=()=>{s(u=>!u)},Fe=u=>{logseq.updateSettings({calendarList:1,subscriptionList:1}),logseq.updateSettings({subscriptionList:[],...u}),u.weekStartDay!==logseq.settings?.weekStartDay&&f.current?.setOptions({week:{startDayOfWeek:u.weekStartDay},month:{startDayOfWeek:u.weekStartDay}}),v(Boolean(u.logKey?.enabled)&&C==="week"),setTimeout(()=>{Oe(),F()},500),M(!1)},Be=async()=>{if(C==="day"&&a){const{preferredDateFormat:u}=await logseq.App.getUserConfigs(),g=K(R(a,Z,new Date),u);logseq.App.pushState("page",{name:g}),logseq.hideMainUI()}},Re=u=>{(o.concat(m)?.map(q=>q.id)).forEach(q=>{u.includes(q)?f.current?.toggleSchedules(q,!1):f.current?.toggleSchedules(q,!0)})};return O.exports.useEffect(()=>{Oe(),setTimeout(()=>{f.current=new tt("#calendar",{...t}),A(),F(),f.current.on("clickDayname",function(u){const g=f.current;g?.getViewName()==="week"&&(g.setDate(new Date(u.date)),g.changeView("day",!0),A(),h("day"))}),f.current.on("clickSchedule",function(u){document.querySelector("#faiz-nav-detail")?.addEventListener("click",async g=>{const q=u.schedule.raw||{},{id:ee,originalName:ue}=q?.page||{};let te=ue;te||(te=(await logseq.Editor.getPage(ee))?.originalName);const{uuid:re}=await logseq.Editor.getBlock(q.id)||{uuid:""};logseq.Editor.scrollToBlockInPage(te,re),logseq.hideMainUI()},{once:!0})}),f.current.on("beforeCreateSchedule",function(u){P({visible:!0,type:"create",values:{start:S(u.start),end:S(u.end),isAllDay:u.triggerEventName==="dblclick"}})}),f.current.on("beforeUpdateSchedule",async function(u){console.log("[faiz:] === beforeUpdateSchedule",u);const{schedule:g,changes:q,triggerEventName:ee,start:ue,end:te}=u;if(ee==="click")P({visible:!0,type:"update",values:{id:g.id,start:S(g.start),end:S(g.end),isAllDay:g.isAllDay,calendarId:g.calendarId,title:g.raw?.content?.split(`
`)[0],raw:g.raw}});else if(q){if(g.calendarId==="journal"&&!S(ue).isSame(S(te),"day"))return logseq.App.showMsg("Journal schedule cannot span multiple days","error");let re={},we={};if(Object.keys(q).forEach(U=>{g.isAllDay?re[U]=S(q[U]).format("YYYY-MM-DD"):re[U]=S(q[U]).format("YYYY-MM-DD HH:mm"),we[U]=S(q[U]).format()}),f.current?.updateSchedule(g.id,g.calendarId,q),g.calendarId==="journal"){const U=g?.raw?.marker,Ce=g?.isAllDay?!1:`${U} `+Me(g?.raw?.content?.replace(new RegExp(`^${U} `),""),S(g?.start).format("HH:mm"),S(g?.end).format("HH:mm"));if(q.start&&!S(q.start).isSame(S(String(g?.raw?.page?.journalDay),"YYYYMMDD"),"day")){console.log("[faiz:] === move journal schedule");const{preferredDateFormat:_e}=await logseq.App.getUserConfigs(),je=K(S(q.start).valueOf(),_e),me=await Le(g.raw?.id,je,Ce);console.log("[faiz:] === newBlock",me,g,g?.id),me&&(f.current?.deleteSchedule(String(g.id),g.calendarId),f.current?.createSchedules([await Q({...g,blockData:me,calendarConfig:l?.find(He=>He.id==="journal")})]))}else await de(g.raw?.id,Ce)}else await de(Number(g.id),!1,re)}}),f.current.on("beforeDeleteSchedule",function(u){const{schedule:g}=u;X.confirm({title:"Are you sure delete this schedule?",content:e("div",{className:"whitespace-pre-line",children:g.raw?.content}),onOk:async()=>{const q=await logseq.Editor.getBlock(g.raw?.id);if(!q)return logseq.App.showMsg("Block not found","error");logseq.Editor.removeBlock(q?.uuid),f.current?.deleteSchedule(g.id,g.calendarId)}})})},0)},[]),O.exports.useEffect(()=>{f?.current?.render()},[k]),O.exports.useEffect(()=>{const u=()=>logseq.hideMainUI();return wt(u),()=>{document.removeEventListener("keyup",u)}},[]),w("div",{className:"w-screen h-screen flex items-center justify-center",children:[e("div",{className:"mask w-screen h-screen fixed top-0 left-0 bg-black bg-opacity-50",onClick:()=>logseq.hideMainUI()}),w("div",{className:`${k?"w-full h-full":"w-5/6"} flex flex-col justify-center overflow-hidden bg-white relative rounded text-black p-3`,style:{maxWidth:k?"none":"1200px"},children:[w("div",{className:`mb-2 flex items-center justify-between ${k&&p?"ml-20":""}`,children:[w("div",{className:"flex items-center",children:[e(L,{className:"mr-2",onClick:N,icon:i?e(rt,{}):e(at,{})}),e(Y,{value:C,defaultValue:t.defaultView,onChange:H,options:Ie,style:{width:"100px"}}),e(L,{className:"ml-4",shape:"round",onClick:z,children:"Today"}),e(L,{className:"ml-4",shape:"circle",icon:e(nt,{}),onClick:b}),e(L,{className:"ml-1",shape:"circle",icon:e(lt,{}),onClick:E}),e(ne,{title:C==="day"?"Navigate to this journal note":"",children:e("span",{className:`ml-4 text-xl h-full items-center inline-block ${C==="day"?"cursor-pointer":"cursor-auto"}`,style:{height:"34px",lineHeight:"34px"},onClick:Be,children:a})})]}),w("div",{children:[x&&e(L,{className:"mr-4",onClick:j,children:"Export Weekly"}),e(L,{className:"mr-4",onClick:()=>M(!0),shape:"circle",icon:e(ot,{})}),e(L,{onClick:W,shape:"circle",icon:k?e(st,{}):e(it,{})})]})]}),w("div",{className:"flex flex-1",children:[e("div",{className:`transition-all overflow-hidden bg-gray-100 mr-2 ${i?"w-0 mr-0":"w-40"}`,children:e(Pt,{onShowCalendarChange:Re,calendarList:o,subscriptionList:m})}),e("div",{className:"flex-1",children:e("div",{id:"calendar",style:{height:k?"100%":"624px"}})})]}),e(Tt,{visible:I.visible,start:I.start,end:I.end,onCancel:()=>T({visible:!1})}),e(Ot,{visible:J,onCancel:()=>M(!1),onOk:Fe}),$.visible?e(Nt,{visible:$.visible,type:$.type,initialValues:$.values,calendar:f.current,onCancel:()=>{P({visible:!1}),f.current?.render()},onSave:()=>{P({visible:!1})}}):null]})]})};S.extend(dt);S.extend(ut);console.log("=== logseq-plugin-agenda loaded ==="),logseq.ready(()=>{xt(),logseq.on("ui:visible:changed",r=>{r.visible||xe.unmountComponentAtNode(document.getElementById("root"))}),logseq.provideModel({show(){Pe("logseq"),logseq.showMainUI()}}),logseq.App.registerUIItem("toolbar",{key:"logseq-plugin-agenda",template:'<a data-on-click="show" class="button"><i class="ti ti-comet"></i></a>'}),logseq.App.registerCommandPalette({key:"logseq-plugin-agenda:show",label:"Show Agenda"},r=>{Pe("logseq"),logseq.showMainUI()})});function Pe(r){xe.render(e(mt.StrictMode,{children:e(Ft,{env:r})}),document.getElementById("root"))}
